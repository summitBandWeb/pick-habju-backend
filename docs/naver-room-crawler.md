# 🎯 네이버 합주실 데이터 수집 시스템

## 1. 이 시스템은 무엇인가요?

**네이버 지도에서 합주실 정보를 자동으로 수집하여 데이터베이스에 저장하는 모듈**입니다.

사용자가 "홍대 합주실"을 검색하면, 이 시스템이:
1. 네이버 지도에서 해당 검색어로 합주실들을 찾고
2. 각 합주실의 상세 정보(가격, 수용인원, 이미지 등)를 가져와서
3. AI가 비정형 데이터를 정리하고
4. Supabase 데이터베이스에 저장합니다.

---

## 2. 왜 이 시스템이 필요한가요?

### 문제 상황
- 합주실 정보는 네이버 예약 페이지에 흩어져 있음
- 룸 이름이 "[평일]블랙룸 (3~5인)" 같은 비정형 텍스트로 되어 있음
- 인원, 가격 정보가 설명에 섞여 있어 파싱이 필요함

### 해결책
- 자동화된 크롤링으로 **전국 합주실 데이터를 수집**
- LLM(AI)을 활용해 **비정형 텍스트를 구조화된 데이터로 변환**
- 수집된 데이터로 "내 인원수에 맞는 합주실" 필터링 가능

---

## 3. 시스템 구조

```
[검색 키워드]
     ↓
┌─────────────────────────────────────┐
│  NaverMapCrawler (Playwright)       │  ← 지도에서 합주실 목록 수집
│  "홍대 합주실" → [business_id 목록] │
└─────────────────────────────────────┘
     ↓
┌─────────────────────────────────────┐
│  NaverRoomFetcher (GraphQL API)     │  ← 각 업소의 상세 정보 수집
│  business_id → 룸 정보, 가격, 이미지 │
└─────────────────────────────────────┘
     ↓
┌─────────────────────────────────────┐
│  RoomParserService (LLM)            │  ← AI가 텍스트 정리
│  "[평일]블랙룸" → {clean_name, ...}  │
└─────────────────────────────────────┘
     ↓
┌─────────────────────────────────────┐
│  RoomCollectionService (Orchestrator)│  ← 전체 흐름 관리
│  수집 → 파싱 → DB 저장               │
└─────────────────────────────────────┘
```

---

## 4. 주요 설계 결정

### 4.1 왜 Playwright를 선택했나요?

| 대안 | 장점 | 단점 | 최종 선택 |
|------|------|------|----------|
| **requests + BeautifulSoup** | 가볍고 빠름 | 자바스크립트 렌더링 불가 ❌ | - |
| **Selenium** | 익숙함 | 무겁고 느림 | - |
| **Playwright** | 빠름, 안정적, headless 지원 | 설치 필요 | ✅ 선택 |

> 네이버 지도는 **클라이언트 사이드 렌더링**을 사용해서 JavaScript 실행이 필수입니다.

**추가 조치**: 네이버가 headless 브라우저를 감지해서 차단하기 때문에, **Stealth 모드**를 적용했습니다.


### 4.2 왜 LLM을 사용했나요?

룸 이름 예시:
- `[평일] 블랙룸 (3~5인/당일예약문의)`
- `주말-A룸(최대8명)`

이런 텍스트에서 "이름", "인원수", "평일/주말" 등을 추출하려면:

| 방법 | 정확도 | 유지보수성 |
|------|--------|------------|
| 정규표현식 | 70% (패턴이 다양해서 누락 많음) | 어려움 |
| **LLM (AI)** | 95%+ | 프롬프트 수정만으로 개선 가능 ✅ |

> 정규표현식을 **Fallback**으로 남겨두어, LLM이 실패해도 기본 파싱이 동작합니다.


### 4.3 왜 Ollama를 사용하나요?

| 특징 | 설명 |
|------|------|
| **무료** | 로컬에서 실행, API 비용 없음 |
| **무제한** | Rate limit 없음 |
| **GPU 활용** | RTX 그래픽카드 가속 |
| **프라이버시** | 데이터가 외부 서버로 전송되지 않음 |

> 환경변수 `LLM_PROVIDER=ollama` (기본값)  
> 모델: **llama3.1** (8B)


### 4.4 왜 동시성(Concurrency) 처리를 했나요?

- 한 업소당 평균 8~15개의 룸이 있음
- 하나씩 순차 처리 시 LLM 응답 대기 시간이 길어짐
- **배치 크기 5개 × 동시 3배치** = 15개 룸을 병렬 처리

| 방식 | 15개 룸 처리 시간 |
|------|------------------|
| 순차 처리 | ~45초 |
| **병렬 배치 처리** | ~15초 ⚡ |


### 4.5 파싱 실패 시 기본값이 왜 100인가요?

- 기존에는 `1`을 기본값으로 사용 → 실제 1인실과 구분 불가
- **100명을 수용하는 합주실은 현실적으로 없음**
- DB에서 `max_capacity = 100`인 데이터를 조회하면 **수동 검토 필요 항목**을 바로 찾을 수 있음

---

## 5. 사용 방법

```bash
python scripts/collect_rooms.py --auto
```

> 서울 25개 구 + 주요 광역시를 순차적으로 크롤링하여 DB에 저장합니다.

---

## 6. 관련 파일 구조

| 경로 | 역할 |
|------|------|
| `app/crawler/naver_map_crawler.py` | 네이버 지도에서 업소 ID 수집 |
| `app/crawler/naver_room_fetcher.py` | GraphQL API로 상세 정보 수집 |
| `app/services/room_parser_service.py` | LLM을 통한 텍스트 파싱 |
| `app/services/room_collection_service.py` | 전체 흐름 관리 (Orchestrator) |
| `scripts/collect_rooms.py` | CLI 실행 스크립트 |

---

## 7. 향후 개선 사항

| 항목 | 설명 | 우선순위 |
|------|------|----------|
| PostGIS 공간 인덱스 | "내 주변 2km 합주실" 검색 성능 최적화 | 🔴 높음 |
| 지역 컬럼 추가 | 지역별 필터링 및 인덱싱 | 🟡 중간 |
| 스케줄링 | 정기적인 자동 수집 (Cron/Cloud Scheduler) | 🟢 낮음 |

---

## 8. 작성자 & 기여

- **작성자**: KKS
- **관련 이슈**: #106
- **마지막 업데이트**: 2026-01-30
