# =============================================================================
# Cloud Run Î∞∞Ìè¨ ÏõåÌÅ¨ÌîåÎ°úÏö∞ (WIF Í∏∞Î∞ò)
# =============================================================================
# - main Î∏åÎûúÏπò ‚Üí prod-service (Cloud Run)
# - dev Î∏åÎûúÏπò ‚Üí alpha-service (Cloud Run)
# - feature/cloud-run-migration ‚Üí alpha-service (ÌÖåÏä§Ìä∏Ïö©, Í≤ÄÏ¶ù ÌõÑ Ï†úÍ±∞)
# =============================================================================
# [ÌÖåÏä§Ìä∏ ÏôÑÎ£å ÌõÑ Ï†ÑÌôò Í∞ÄÏù¥Îìú]
# 1. ÏïÑÎûò branchesÏóêÏÑú 'feature/cloud-run-migration' ÎùºÏù∏ Ï†úÍ±∞
# 2. Ï°∞Í±¥Î¨∏ ÏÑπÏÖòÏóêÏÑú feature/cloud-run-migration Í¥ÄÎ†® ÎùºÏù∏ Ï†úÍ±∞
# 3. dev Î∏åÎûúÏπòÏóê Î®∏ÏßÄÌïòÎ©¥ ÏûêÎèôÏúºÎ°ú alpha-serviceÏóê Î∞∞Ìè¨Îê®
# =============================================================================
name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
      - dev
      - feature/cloud-run-migration  # ÌÖåÏä§Ìä∏Ïö© - Í≤ÄÏ¶ù ÌõÑ Ï†úÍ±∞

env:
  # -------------------------------------------------------------------------
  # GCP ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Ï†ï
  # -------------------------------------------------------------------------
  PROJECT_ID: project-6f6602b3-6e99-4dd6-b98
  REGION: asia-northeast3
  GAR_REPOSITORY: pickhabju-repo
  IMAGE_NAME: pickhabju-backend
  
  # -------------------------------------------------------------------------
  # Cloud Run Ïù∏Ïä§ÌÑ¥Ïä§ ÏÑ§Ï†ï (ÏâΩÍ≤å Î≥ÄÍ≤Ω Í∞ÄÎä•)
  # -------------------------------------------------------------------------
  # [ÏΩúÎìú Ïä§ÌÉÄÌä∏ Î∞©ÏßÄÍ∞Ä ÌïÑÏöîÌïòÎ©¥ PROD_MIN_INSTANCESÎ•º 1Î°ú Î≥ÄÍ≤Ω]
  PROD_MIN_INSTANCES: "0"
  PROD_MAX_INSTANCES: "10"
  ALPHA_MIN_INSTANCES: "0"
  ALPHA_MAX_INSTANCES: "5"

jobs:
  # ===========================================================================
  # 1) ÌÖåÏä§Ìä∏
  # ===========================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Python ÏÖãÏóÖ
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: ./requirements.txt

      - name: ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install -r ./requirements.txt

      - name: ÌÖåÏä§Ìä∏ Ïã§Ìñâ
        id: pytest_run
        run: |
          source venv/bin/activate
          pip install pytest-json-report
          pytest --json-report --json-report-file=test_results.json

      - name: ÌÖåÏä§Ìä∏ Ïã§Ìå® Ïãú Discord ÏïåÎ¶º
        if: always() && steps.pytest_run.outcome == 'failure'
        run: |
          if [ -f test_results.json ]; then
            FAILED_TESTS=$(jq -r '.summary.failed // 0' test_results.json)
            FAILED_TEST_DETAILS=$(jq -r '.report.tests[] | select(.outcome == "failed") | .nodeid' test_results.json | head -n 5)
            if [ "$FAILED_TESTS" -gt 0 ]; then
                DETAILS_MESSAGE="**Ïã§Ìå®Ìïú ÌÖåÏä§Ìä∏ Í∞úÏàò**: ${FAILED_TESTS}\n"
                DETAILS_MESSAGE="${DETAILS_MESSAGE}**Ïã§Ìå® ÌÖåÏä§Ìä∏ Î™©Î°ù (ÏùºÎ∂Ä)**:\n\`\`\`\n${FAILED_TEST_DETAILS}\n\`\`\`"
            else
                DETAILS_MESSAGE="ÌÖåÏä§Ìä∏ Ïã§Ìå® ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§."
            fi
          else
            DETAILS_MESSAGE="ÌÖåÏä§Ìä∏ Í≤∞Í≥º JSON ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."
          fi

          curl -H "Content-Type: application/json" -d "{
            \"content\": \"üö® **ÌÖåÏä§Ìä∏ Ïã§Ìå®!** Î∞∞Ìè¨Í∞Ä Ï§ëÎã®ÎêòÏóàÏäµÎãàÎã§.\",
            \"embeds\": [
              {
                \"title\": \"Ïã§Ìå®Ìïú ÏõåÌÅ¨ÌîåÎ°úÏö∞ Î∞îÎ°úÍ∞ÄÍ∏∞\",
                \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
                \"color\": 15158332,
                \"fields\": [
                  { \"name\": \"Repository\", \"value\": \"${{ github.repository }}\", \"inline\": true },
                  { \"name\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"inline\": true },
                  { \"name\": \"Commit\", \"value\": \"\`${{ github.sha }}\`\", \"inline\": true },
                  { \"name\": \"Ïã§Ìå® ÏÉÅÏÑ∏\", \"value\": \"${DETAILS_MESSAGE}\", \"inline\": false }
                ]
              }
            ]
          }" ${{ secrets.DISCORD_WEBHOOK_URL }}

  # ===========================================================================
  # 2) Build & Deploy to Cloud Run
  # ===========================================================================
  deploy:
    name: Deploy
    needs: test
    if: ${{ needs.test.result == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # WIF(Workload Identity Federation)Ïóê ÌïÑÏöî
      contents: read

    steps:
      - uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Î∏åÎûúÏπòÎ≥Ñ ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï
      # -----------------------------------------------------------------------
      - name: Set environment variables
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "SERVICE_NAME=prod-service" >> $GITHUB_ENV
            echo "ENV_LABEL=PROD" >> $GITHUB_ENV
            echo "MIN_INSTANCES=${{ env.PROD_MIN_INSTANCES }}" >> $GITHUB_ENV
            echo "MAX_INSTANCES=${{ env.PROD_MAX_INSTANCES }}" >> $GITHUB_ENV
            echo "SUPABASE_URL=${{ secrets.PROD_SUPABASE_URL }}" >> $GITHUB_ENV
            echo "SUPABASE_KEY=${{ secrets.PROD_SUPABASE_KEY }}" >> $GITHUB_ENV
          else
            echo "SERVICE_NAME=alpha-service" >> $GITHUB_ENV
            echo "ENV_LABEL=ALPHA" >> $GITHUB_ENV
            echo "MIN_INSTANCES=${{ env.ALPHA_MIN_INSTANCES }}" >> $GITHUB_ENV
            echo "MAX_INSTANCES=${{ env.ALPHA_MAX_INSTANCES }}" >> $GITHUB_ENV
            echo "SUPABASE_URL=${{ secrets.ALPHA_SUPABASE_URL }}" >> $GITHUB_ENV
            echo "SUPABASE_KEY=${{ secrets.ALPHA_SUPABASE_KEY }}" >> $GITHUB_ENV
          fi

      # -----------------------------------------------------------------------
      # GCP Ïù∏Ï¶ù (Workload Identity Federation)
      # -----------------------------------------------------------------------
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # -----------------------------------------------------------------------
      # Docker Ïù∏Ï¶ù & ÎπåÎìú & GAR Push
      # -----------------------------------------------------------------------
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build Docker image
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker tag ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
                     ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:latest

      - name: Push to Artifact Registry
        run: |
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:latest

      # -----------------------------------------------------------------------
      # Cloud Run Î∞∞Ìè¨
      # -----------------------------------------------------------------------
      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          # ÏΩúÎìú Ïä§ÌÉÄÌä∏ Î∞©ÏßÄ Î∞è Ïã§ÏãúÍ∞ÑÏÑ± ÏµúÏ†ÅÌôî
          flags: |
            --min-instances=${{ env.MIN_INSTANCES }}
            --max-instances=${{ env.MAX_INSTANCES }}
            --cpu-boost
            --allow-unauthenticated
          # ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï (Supabase Îì±)
          env_vars: |
            SUPABASE_URL=${{ env.SUPABASE_URL }}
            SUPABASE_KEY=${{ env.SUPABASE_KEY }}

      # -----------------------------------------------------------------------
      # Discord Î∞∞Ìè¨ ÏÑ±Í≥µ ÏïåÎ¶º
      # -----------------------------------------------------------------------
      - name: Discord Î∞∞Ìè¨ ÏÑ±Í≥µ ÏïåÎ¶º
        if: success()
        run: |
          curl -H "Content-Type: application/json" -d '{
            "content": "‚úÖ **[${{ env.ENV_LABEL }} ÏÑúÎ≤Ñ] Cloud Run Î∞∞Ìè¨ ÏÑ±Í≥µ!**",
            "embeds": [
              {
                "title": "Î∞∞Ìè¨Îêú ÏõåÌÅ¨ÌîåÎ°úÏö∞ Î∞îÎ°úÍ∞ÄÍ∏∞",
                "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                "color": 3066993,
                "fields": [
                  { "name": "Service", "value": "`${{ env.SERVICE_NAME }}`", "inline": true },
                  { "name": "Region", "value": "`${{ env.REGION }}`", "inline": true },
                  { "name": "Branch", "value": "`${{ github.ref_name }}`", "inline": true },
                  { "name": "Commit", "value": "`${{ github.sha }}`", "inline": true },
                  { "name": "URL", "value": "${{ steps.deploy.outputs.url }}", "inline": false }
                ]
              }
            ]
          }' ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Discord Î∞∞Ìè¨ Ïã§Ìå® ÏïåÎ¶º
        if: failure()
        run: |
          curl -H "Content-Type: application/json" -d '{
            "content": "üö® **[${{ env.ENV_LABEL }} ÏÑúÎ≤Ñ] Cloud Run Î∞∞Ìè¨ Ïã§Ìå®!**",
            "embeds": [
              {
                "title": "Ïã§Ìå®Ìïú ÏõåÌÅ¨ÌîåÎ°úÏö∞ Î∞îÎ°úÍ∞ÄÍ∏∞",
                "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                "color": 15158332,
                "fields": [
                  { "name": "Service", "value": "`${{ env.SERVICE_NAME }}`", "inline": true },
                  { "name": "Branch", "value": "`${{ github.ref_name }}`", "inline": true },
                  { "name": "Commit", "value": "`${{ github.sha }}`", "inline": true }
                ]
              }
            ]
          }' ${{ secrets.DISCORD_WEBHOOK_URL }}
