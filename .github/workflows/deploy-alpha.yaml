# =============================================================================
# ALPHA í™˜ê²½ CI/CD íŒŒì´í”„ë¼ì¸
# =============================================================================
# Trigger: dev ë¸Œëœì¹˜ push
# Target: alpha-service (Cloud Run)
# =============================================================================
name: ALPHA CI/CD Pipeline

on:
  push:
    branches:
      - dev

env:
  # GCP í”„ë¡œì íŠ¸ ì„¤ì •
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  GAR_REPOSITORY: pickhabju-repo
  IMAGE_NAME: pickhabju-backend
  SERVICE_NAME: alpha-service
  
  # Cloud Run ì¸ìŠ¤í„´ìŠ¤ ì„¤ì •
  MIN_INSTANCES: "0"
  MAX_INSTANCES: "5"

jobs:
  # ===========================================================================
  # 1) í…ŒìŠ¤íŠ¸
  # ===========================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Python ì…‹ì—…
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: ./requirements.txt

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install -r ./requirements.txt

      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        id: pytest_run
        env:
          SUPABASE_URL: ${{ secrets.ALPHA_SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.ALPHA_SUPABASE_KEY }}
          GROOVE_BASE_URL: ${{ secrets.GROOVE_BASE_URL }}
          DREAM_BASE_URL: ${{ secrets.DREAM_BASE_URL }}
        run: |
          source venv/bin/activate
          pip install pytest-json-report
          pytest --json-report --json-report-file=test_results.json

      - name: í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ Discord ì•Œë¦¼
        if: always() && steps.pytest_run.outcome == 'failure'
        run: |
          if [ -f test_results.json ]; then
            FAILED_TESTS=$(jq -r '.summary.failed // 0' test_results.json)
            FAILED_TEST_DETAILS=$(jq -r '.report.tests[] | select(.outcome == "failed") | .nodeid' test_results.json | head -n 5)
            if [ "$FAILED_TESTS" -gt 0 ]; then
                DETAILS_MESSAGE="**ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ ê°œìˆ˜**: ${FAILED_TESTS}\\n"
                DETAILS_MESSAGE="${DETAILS_MESSAGE}**ì‹¤íŒ¨ í…ŒìŠ¤íŠ¸ ëª©ë¡ (ì¼ë¶€)**:\\n\`\`\`\\n${FAILED_TEST_DETAILS}\\n\`\`\`"
            else
                DETAILS_MESSAGE="í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ìƒì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            fi
          else
            DETAILS_MESSAGE="í…ŒìŠ¤íŠ¸ ê²°ê³¼ JSON íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          fi

          curl -H "Content-Type: application/json" -d "{
            \"content\": \"ğŸš¨ **[ALPHA] í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!** ë°°í¬ê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.\",
            \"embeds\": [
              {
                \"title\": \"ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš° ë°”ë¡œê°€ê¸°\",
                \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
                \"color\": 15158332,
                \"fields\": [
                  { \"name\": \"Repository\", \"value\": \"${{ github.repository }}\", \"inline\": true },
                  { \"name\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"inline\": true },
                  { \"name\": \"Commit\", \"value\": \"\`${{ github.sha }}\`\", \"inline\": true },
                  { \"name\": \"ì‹¤íŒ¨ ìƒì„¸\", \"value\": \"${DETAILS_MESSAGE}\", \"inline\": false }
                ]
              }
            ]
          }" ${{ secrets.DISCORD_WEBHOOK_URL }}

  # ===========================================================================
  # 2) Build & Deploy to Cloud Run
  # ===========================================================================
  deploy:
    name: Deploy to ALPHA
    needs: test
    if: ${{ needs.test.result == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # GCP ì¸ì¦ (Workload Identity Federation)
      # -----------------------------------------------------------------------
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # -----------------------------------------------------------------------
      # Docker ë¹Œë“œ & Push
      # -----------------------------------------------------------------------
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build Docker image
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker tag ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
                     ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:alpha-latest

      - name: Push to Artifact Registry
        run: |
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:alpha-latest

      # -----------------------------------------------------------------------
      # Cloud Run ë°°í¬
      # -----------------------------------------------------------------------
      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          flags: |
            --min-instances=${{ env.MIN_INSTANCES }}
            --max-instances=${{ env.MAX_INSTANCES }}
            --cpu-boost
            --allow-unauthenticated
          env_vars: |
            LOGIN_ID=${{ secrets.LOGIN_ID }}
            LOGIN_PW=${{ secrets.LOGIN_PW }}
            GROOVE_BASE_URL=${{ secrets.GROOVE_BASE_URL }}
            DREAM_BASE_URL=${{ secrets.DREAM_BASE_URL }}
            PYTHONPATH=${{ secrets.PYTHONPATH }}
            CORS_ALLOWED_ORIGINS=${{ secrets.ALPHA_CORS_ALLOWED_ORIGINS }}
            CORS_ORIGIN_REGEX=${{ secrets.ALPHA_CORS_ORIGIN_REGEX }}
            SUPABASE_URL=${{ secrets.ALPHA_SUPABASE_URL }}
            SUPABASE_KEY=${{ secrets.ALPHA_SUPABASE_KEY }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            RATE_LIMIT_PER_MINUTE=${{ secrets.RATE_LIMIT_PER_MINUTE }}

      # -----------------------------------------------------------------------
      # Discord ì•Œë¦¼
      # -----------------------------------------------------------------------
      - name: Discord ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: success()
        run: |
          curl -H "Content-Type: application/json" -d '{
            "content": "âœ… **[ALPHA ì„œë²„] Cloud Run ë°°í¬ ì„±ê³µ!**",
            "embeds": [
              {
                "title": "ë°°í¬ëœ ì›Œí¬í”Œë¡œìš° ë°”ë¡œê°€ê¸°",
                "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                "color": 3066993,
                "fields": [
                  { "name": "Service", "value": "`${{ env.SERVICE_NAME }}`", "inline": true },
                  { "name": "Region", "value": "`${{ env.REGION }}`", "inline": true },
                  { "name": "Branch", "value": "`${{ github.ref_name }}`", "inline": true },
                  { "name": "Commit", "value": "`${{ github.sha }}`", "inline": true },
                  { "name": "URL", "value": "${{ steps.deploy.outputs.url }}", "inline": false }
                ]
              }
            ]
          }' ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Discord ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        run: |
          curl -H "Content-Type: application/json" -d '{
            "content": "ğŸš¨ **[ALPHA ì„œë²„] Cloud Run ë°°í¬ ì‹¤íŒ¨!**",
            "embeds": [
              {
                "title": "ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš° ë°”ë¡œê°€ê¸°",
                "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                "color": 15158332,
                "fields": [
                  { "name": "Service", "value": "`${{ env.SERVICE_NAME }}`", "inline": true },
                  { "name": "Branch", "value": "`${{ github.ref_name }}`", "inline": true },
                  { "name": "Commit", "value": "`${{ github.sha }}`", "inline": true }
                ]
              }
            ]
          }' ${{ secrets.DISCORD_WEBHOOK_URL }}
