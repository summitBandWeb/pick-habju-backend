name: EC2 Hourly Running Notice

on:
  schedule:
    - cron: "0 * * * *"   # 매시 정각(UTC) → KST에서도 매시 정각
  workflow_dispatch:       # 수동 테스트용

jobs:
  hourly_notice:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2            # 예: ap-northeast-2

      - name: Get instance status
        id: ec2
        run: |
          ID="${{ secrets.ALPHA_INSTANCE_ID }}"
          STATE=$(aws ec2 describe-instances --instance-ids "$ID" \
            --query "Reservations[0].Instances[0].State.Name" --output text)
          PUBIP=$(aws ec2 describe-instances --instance-ids "$ID" \
            --query "Reservations[0].Instances[0].PublicIpAddress" --output text)
          NAME=$(aws ec2 describe-instances --instance-ids "$ID" \
            --query "Reservations[0].Instances[0].Tags[?Key=='Name'].Value | [0]" --output text)

          echo "state=$STATE" >> "$GITHUB_OUTPUT"
          echo "pubip=$PUBIP" >> "$GITHUB_OUTPUT"
          echo "name=$NAME"  >> "$GITHUB_OUTPUT"

      - name: Send Discord if running
        if: ${{ steps.ec2.outputs.state == 'running' }}
        run: |
          NAME="${{ steps.ec2.outputs.name }}"
          PUBIP="${{ steps.ec2.outputs.pubip }}"
          STATE="${{ steps.ec2.outputs.state }}"

          # 깔끔한 메시지 구성
          read -r -d '' PAYLOAD << 'JSON'
          {
            "content": "🟢 **ALPHA 서버가 실행중입니다.**",
            "embeds": [
              {
                "title": "EC2 상태",
                "color": 3066993,
                "fields": [
                  { "name": "Name", "value": "%%NAME%%", "inline": true },
                  { "name": "State", "value": "%%STATE%%", "inline": true },
                  { "name": "Public IP", "value": "%%PUBIP%%", "inline": true }
                ],
                "footer": { "text": "매시 정각 자동 알림" }
              }
            ]
          }
          JSON

          PAYLOAD="${PAYLOAD//%%NAME%%/${NAME:-(no-tag)}}"
          PAYLOAD="${PAYLOAD//%%STATE%%/${STATE}}"
          PAYLOAD="${PAYLOAD//%%PUBIP%%/${PUBIP}}"

          curl -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "${{ secrets.DISCORD_WEBHOOK_URL }}"
