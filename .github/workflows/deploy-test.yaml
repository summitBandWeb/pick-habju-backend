# =============================================================================
# í…ŒìŠ¤íŠ¸ìš© CI/CD íŒŒì´í”„ë¼ì¸ (Alpha + Prod í†µí•© í…ŒìŠ¤íŠ¸)
# =============================================================================
# Trigger: config/100-gcp-architecture-setup ë¸Œëœì¹˜ push
# Purpose: ë‘ í™˜ê²½ì˜ ì›Œí¬í”Œë¡œìš°ë¥¼ í…ŒìŠ¤íŠ¸ ë¸Œëœì¹˜ì—ì„œ ê²€ì¦
# =============================================================================
name: TEST CI/CD Pipeline

on:
  push:
    branches:
      - config/100-gcp-architecture-setup

env:
  # GCP í”„ë¡œì íŠ¸ ì„¤ì •
  PROJECT_ID: project-6f6602b3-6e99-4dd6-b98
  REGION: us-central1
  GAR_REPOSITORY: pickhabju-repo
  IMAGE_NAME: pickhabju-backend
  
  # í…ŒìŠ¤íŠ¸ìš©: Alpha ì„œë¹„ìŠ¤ì— ë°°í¬ (Prod ì˜í–¥ ì—†ìŒ)
  SERVICE_NAME: alpha-service
  
  # Cloud Run ì¸ìŠ¤í„´ìŠ¤ ì„¤ì •
  MIN_INSTANCES: "0"
  MAX_INSTANCES: "5"

jobs:
  # ===========================================================================
  # 1) í…ŒìŠ¤íŠ¸
  # ===========================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Python ì…‹ì—…
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: ./requirements.txt

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install -r ./requirements.txt

      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        id: pytest_run
        run: |
          source venv/bin/activate
          pip install pytest-json-report
          pytest --json-report --json-report-file=test_results.json

      - name: í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ Discord ì•Œë¦¼
        if: always() && steps.pytest_run.outcome == 'failure'
        run: |
          if [ -f test_results.json ]; then
            FAILED_TESTS=$(jq -r '.summary.failed // 0' test_results.json)
            FAILED_TEST_DETAILS=$(jq -r '.report.tests[] | select(.outcome == "failed") | .nodeid' test_results.json | head -n 5)
            if [ "$FAILED_TESTS" -gt 0 ]; then
                DETAILS_MESSAGE="**ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ ê°œìˆ˜**: ${FAILED_TESTS}\\n"
                DETAILS_MESSAGE="${DETAILS_MESSAGE}**ì‹¤íŒ¨ í…ŒìŠ¤íŠ¸ ëª©ë¡ (ì¼ë¶€)**:\\n\`\`\`\\n${FAILED_TEST_DETAILS}\\n\`\`\`"
            else
                DETAILS_MESSAGE="í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ìƒì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            fi
          else
            DETAILS_MESSAGE="í…ŒìŠ¤íŠ¸ ê²°ê³¼ JSON íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          fi

          curl -H "Content-Type: application/json" -d "{
            \"content\": \"ğŸš¨ **[TEST] í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!** ë°°í¬ê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.\",
            \"embeds\": [
              {
                \"title\": \"ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš° ë°”ë¡œê°€ê¸°\",
                \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
                \"color\": 15158332,
                \"fields\": [
                  { \"name\": \"Repository\", \"value\": \"${{ github.repository }}\", \"inline\": true },
                  { \"name\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"inline\": true },
                  { \"name\": \"Commit\", \"value\": \"\`${{ github.sha }}\`\", \"inline\": true },
                  { \"name\": \"ì‹¤íŒ¨ ìƒì„¸\", \"value\": \"${DETAILS_MESSAGE}\", \"inline\": false }
                ]
              }
            ]
          }" ${{ secrets.DISCORD_WEBHOOK_URL }}

  # ===========================================================================
  # 2) Build & Deploy to Cloud Run (Alpha í™˜ê²½ì— í…ŒìŠ¤íŠ¸ ë°°í¬)
  # ===========================================================================
  deploy:
    name: Deploy to ALPHA (TEST)
    needs: test
    if: ${{ needs.test.result == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # GCP ì¸ì¦ (Workload Identity Federation)
      # -----------------------------------------------------------------------
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # -----------------------------------------------------------------------
      # Docker ë¹Œë“œ & Push
      # -----------------------------------------------------------------------
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build Docker image
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker tag ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
                     ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:test-latest

      - name: Push to Artifact Registry
        run: |
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:test-latest

      # -----------------------------------------------------------------------
      # Supabase DB ë°±ì—… & ë§ˆì´ê·¸ë ˆì´ì…˜ (Alpha DB ì‚¬ìš© - í…ŒìŠ¤íŠ¸ìš©)
      # -----------------------------------------------------------------------
      - name: Setup Node.js for Supabase CLI
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Test DB Backup (Alpha)
        env:
          SUPABASE_DB_HOST: ${{ secrets.PROD_SUPABASE_DB_HOST }}
          SUPABASE_DB_USER: ${{ secrets.PROD_SUPABASE_DB_USER }}
          SUPABASE_DB_PASSWORD: ${{ secrets.PROD_SUPABASE_DB_PASSWORD }}
        run: |
          # ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì´ ìˆì„ ë•Œë§Œ ë°±ì—… ì‹¤í–‰
          if [ -d "supabase/migrations" ] && [ "$(ls -A supabase/migrations/*.sql 2>/dev/null)" ]; then
            echo "ğŸ“¦ [TEST] Creating database backup before migration..."
            
            # PostgreSQL 17 í´ë¼ì´ì–¸íŠ¸ ì„¤ì¹˜ (Supabase ì„œë²„ ë²„ì „ê³¼ ì¼ì¹˜)
            sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
            wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
            sudo apt-get update && sudo apt-get install -y postgresql-client-17
            
            # ë°±ì—… íŒŒì¼ëª… (íƒ€ì„ìŠ¤íƒ¬í”„ í¬í•¨)
            BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).sql"
            
            # pg_dumpë¡œ ë°±ì—… (Session Pooler ì‚¬ìš©)
            PGPASSWORD="${SUPABASE_DB_PASSWORD}" pg_dump \
              -h "${SUPABASE_DB_HOST}" \
              -p 5432 \
              -U "${SUPABASE_DB_USER}" \
              -d postgres \
              --no-owner \
              --no-acl \
              -f "${BACKUP_FILE}"
            
            echo "âœ… [TEST] Backup created: ${BACKUP_FILE}"
            echo "ğŸ“Š Backup size: $(du -h ${BACKUP_FILE} | cut -f1)"
            
            # ë°±ì—… íŒŒì¼ì„ Artifactë¡œ ì—…ë¡œë“œ (GitHubì— 30ì¼ê°„ ë³´ê´€)
            echo "BACKUP_FILE=${BACKUP_FILE}" >> $GITHUB_ENV
          else
            echo "â„¹ï¸ [TEST] No migration files found, skipping backup..."
          fi

      - name: Upload Database Backup
        if: env.BACKUP_FILE != ''
        uses: actions/upload-artifact@v4
        with:
          name: db-backup-test-${{ github.sha }}
          path: ${{ env.BACKUP_FILE }}
          retention-days: 7

      - name: Test Supabase Migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.PROD_SUPABASE_DB_PASSWORD }}
        run: |
          # ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
          if [ -d "supabase/migrations" ] && [ "$(ls -A supabase/migrations/*.sql 2>/dev/null)" ]; then
            echo "ğŸ”„ [TEST] Applying database migrations..."
            
            # Supabase CLI ì„¤ì¹˜ (Linuxìš© ë°”ì´ë„ˆë¦¬ ë‹¤ìš´ë¡œë“œ)
            curl -sSL https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz | tar -xz
            sudo mv supabase /usr/local/bin/supabase
            
            # í”„ë¡œì íŠ¸ ì—°ê²° (í™˜ê²½ë³€ìˆ˜ë¡œ ì§€ì •)
            supabase link --project-ref ${{ secrets.PROD_SUPABASE_PROJECT_REF }}
            
            # ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš©
            supabase db push
            echo "âœ… [TEST] Migrations applied successfully"
            echo "âœ… [TEST] Migrations applied successfully"
          else
            echo "â„¹ï¸ [TEST] No migration files found, skipping..."
          fi

      # -----------------------------------------------------------------------
      # Cloud Run ë°°í¬ (Alpha í™˜ê²½)
      # -----------------------------------------------------------------------
      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          flags: |
            --min-instances=${{ env.MIN_INSTANCES }}
            --max-instances=${{ env.MAX_INSTANCES }}
            --cpu-boost
            --allow-unauthenticated
          env_vars: |
            LOGIN_ID=${{ secrets.LOGIN_ID }}
            LOGIN_PW=${{ secrets.LOGIN_PW }}
            GROOVE_BASE_URL=${{ secrets.GROOVE_BASE_URL }}
            DREAM_BASE_URL=${{ secrets.DREAM_BASE_URL }}
            PYTHONPATH=${{ secrets.PYTHONPATH }}
            CORS_ALLOWED_ORIGINS=${{ secrets.ALPHA_CORS_ALLOWED_ORIGINS }}
            CORS_ORIGIN_REGEX=${{ secrets.ALPHA_CORS_ORIGIN_REGEX }}
            SUPABASE_URL=${{ secrets.ALPHA_SUPABASE_URL }}
            SUPABASE_KEY=${{ secrets.ALPHA_SUPABASE_KEY }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            RATE_LIMIT_PER_MINUTE=${{ secrets.RATE_LIMIT_PER_MINUTE }}

      # -----------------------------------------------------------------------
      # Discord ì•Œë¦¼
      # -----------------------------------------------------------------------
      - name: Discord í…ŒìŠ¤íŠ¸ ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: success()
        run: |
          curl -H "Content-Type: application/json" -d '{
            "content": "ğŸ§ª **[TEST] Cloud Run í…ŒìŠ¤íŠ¸ ë°°í¬ ì„±ê³µ!**",
            "embeds": [
              {
                "title": "í…ŒìŠ¤íŠ¸ ì›Œí¬í”Œë¡œìš° ë°”ë¡œê°€ê¸°",
                "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                "color": 16776960,
                "fields": [
                  { "name": "Service", "value": "`${{ env.SERVICE_NAME }}`", "inline": true },
                  { "name": "Region", "value": "`${{ env.REGION }}`", "inline": true },
                  { "name": "Branch", "value": "`${{ github.ref_name }}`", "inline": true },
                  { "name": "Commit", "value": "`${{ github.sha }}`", "inline": true },
                  { "name": "URL", "value": "${{ steps.deploy.outputs.url }}", "inline": false }
                ]
              }
            ]
          }' ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Discord í…ŒìŠ¤íŠ¸ ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        run: |
          curl -H "Content-Type: application/json" -d '{
            "content": "ğŸš¨ **[TEST] Cloud Run í…ŒìŠ¤íŠ¸ ë°°í¬ ì‹¤íŒ¨!**",
            "embeds": [
              {
                "title": "ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš° ë°”ë¡œê°€ê¸°",
                "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                "color": 15158332,
                "fields": [
                  { "name": "Service", "value": "`${{ env.SERVICE_NAME }}`", "inline": true },
                  { "name": "Branch", "value": "`${{ github.ref_name }}`", "inline": true },
                  { "name": "Commit", "value": "`${{ github.sha }}`", "inline": true }
                ]
              }
            ]
          }' ${{ secrets.DISCORD_WEBHOOK_URL }}
