name: Discord PR SLA & Merge Reminders

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch: {}

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  remind:
    runs-on: ubuntu-latest
    steps:
      - name: Check PRs and remind
        uses: actions/github-script@v7
        env:
          DISCORD_WEBHOOK_PR_ALERTS: ${{ secrets.DISCORD_WEBHOOK_PR_ALERTS }}
        with:
          script: |
            const webhook = process.env.DISCORD_WEBHOOK_PR_ALERTS;
            if (!webhook) throw new Error("Missing DISCORD_WEBHOOK_PR_ALERTS secret.");

            // âœ… ê¸´ê¸‰ ë©˜ì…˜ í•˜ë“œì½”ë”© (priority/high ê´€ë ¨ SLA ê²½ê³ ì— ì‚¬ìš©)
            const URGENT_MENTIONS = [
              "<@545853009628758017>",
              "<@767021891251601440>",
              "<@629493215510265866>",
              "<@880437882957996112>",
            ].join(" ");

            // ---- Bot actors to ignore as "reviewers" ----
            // Claude ì•¡ì…˜ì´ ë‚¨ê¸°ëŠ” ì½”ë©˜íŠ¸ëŠ” "ë¦¬ë·°"ê°€ ì•„ë‹ˆë¼ì„œ ì›ë˜ ì¹´ìš´íŠ¸ ì•ˆ ë¨.
            // ì—¬ê¸°ì„œëŠ” "ë¦¬ë·° ì‘ì„±ì"ê°€ ë´‡ì¸ ê²½ìš°ë¥¼ ë°°ì œ.
            const BOT_ACTORS = new Set([
              "github-actions[bot]",
              "dependabot[bot]",
              "vercel[bot]",
              "claude-ai[bot]",
              "anthropic-claude[bot]",
              "codiumai[bot]"
            ]);

            // ---- Internal reminder marker labels (avoid duplicate notifications) ----
            const BOT_LABELS = [
              "bot/reminded-base-24h",
              "bot/reminded-sla24-24h",
              "bot/reminded-sla48-48h",
              "bot/reminded-merge-48h",
              "bot/reminded-merge-60h",
              "bot/reminded-merge-72h"
            ];

            async function ensureLabel(name) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name
                });
              } catch (e) {
                const status = (e && (e.status !== undefined ? e.status : (e.response && e.response.status)));
                if (status === 404) {
                  try {
                    await github.rest.issues.createLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      name,
                      color: "ededed",
                      description: "internal label used by reminder bot"
                    });
                  } catch (createErr) {
                    try {
                      const msg = "ë¼ë²¨ ìƒì„± ê¶Œí•œ ì—†ìŒ ë˜ëŠ” ì‹¤íŒ¨: " + name;
                      if (typeof core !== "undefined" && core.warning) core.warning(msg); else console.warn(msg);
                    } catch (_) {}
                  }
                }
              }
            }

            for (const l of BOT_LABELS) {
              await ensureLabel(l);
            }

            function hoursSince(iso) {
              return (Date.now() - new Date(iso).getTime()) / (1000 * 60 * 60);
            }

            function hasLabel(pr, name) {
              return (pr.labels || []).some(l => l.name === name);
            }

            async function addBotLabel(prNumber, label) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  labels: [label]
                });
              } catch (e) {
                try {
                  const status = (e && (e.status !== undefined ? e.status : (e.response && e.response.status)));
                  const msg = (status === 403)
                    ? "ë¼ë²¨ ì¶”ê°€ ê¶Œí•œ ì—†ìŒ(403): " + label + " - Discord ì•Œë¦¼ë§Œ ì „ì†¡ë¨."
                    : "addBotLabel ì‹¤íŒ¨: " + (e && e.message || String(e));
                  if (typeof core !== "undefined" && core.warning) core.warning(msg); else console.warn(msg);
                } catch (_) {}
              }
            }

            async function sendDiscord({ content, title, pr, extraFields = [] }) {
              const labels = (pr.labels || []).map(l => l.name);
              const labelText = labels.length ? labels.join(", ") : "(none)";

              const payload = {
                content: content || "",
                embeds: [{
                  title,
                  url: pr.html_url,
                  description: `**${pr.title}**\nPR #${pr.number} â€¢ ${pr.base.ref} â† ${pr.head.ref}`,
                  fields: [
                    { name: "ì‘ì„±ì", value: pr.user.login, inline: true },
                    { name: "ê²½ê³¼ ì‹œê°„", value: `${hoursSince(pr.created_at).toFixed(1)}h`, inline: true },
                    { name: "ë¼ë²¨", value: labelText, inline: false },
                    ...extraFields
                  ],
                  timestamp: new Date().toISOString()
                }]
              };

              const res = await fetch(webhook, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
              });

              if (!res.ok) {
                const txt = await res.text();
                throw new Error(`Discord webhook failed: ${res.status} ${txt}`);
              }
            }

            // Count "valid reviews" per your rules:
            // - exclude PR author
            // - exclude bots
            // - count only Pull Request Reviews (not comments), so Claude comments are ignored automatically
            // - CODEOWNER ê¸°ì¤€:
            //    If requested_reviewers exist => only those reviewers count
            //    If only requested_teams exist => accept any eligible human review (stable compromise)
            async function getValidReviewCount(prNumber, prAuthor) {
              const [reviewsRes, prRes] = await Promise.all([
                github.rest.pulls.listReviews({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  per_page: 100
                }),
                github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber
                })
              ]);

              const requestedReviewers = new Set((prRes.data.requested_reviewers || []).map(u => u.login));
              const hasRequestedReviewers = requestedReviewers.size > 0;
              const hasRequestedTeams = (prRes.data.requested_teams || []).length > 0;

              const eligibleStates = new Set(["APPROVED", "CHANGES_REQUESTED", "COMMENTED"]);
              const reviewers = new Set();

              for (const r of reviewsRes.data) {
                const user = r.user?.login;
                if (!user) continue;
                if (!eligibleStates.has(r.state)) continue;
                if (user === prAuthor) continue;
                if (BOT_ACTORS.has(user)) continue;

                if (hasRequestedReviewers) {
                  if (!requestedReviewers.has(user)) continue;
                } else if (hasRequestedTeams) {
                  // accept any eligible human review
                } else {
                  // no requested reviewers/teams => accept any eligible human review
                }

                reviewers.add(user);
              }

              return reviewers.size;
            }

            // List open PRs (not merged)
            const prs = await github.paginate(github.rest.pulls.list, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              per_page: 100
            });

            for (const pr of prs) {
              if (pr.draft) continue;

              const prNumber = pr.number;
              const ageH = hoursSince(pr.created_at);
              const labels = (pr.labels || []).map(l => l.name);

              const hasPriorityHigh = labels.includes("priority/high");
              const hasReview24 = labels.includes("review/24h");
              const hasReview48 = labels.includes("review/48h");

              // í•„ìš”í•œ ë¦¬ë·° ìˆ˜: í•­ìƒ 1ëª…
              const requiredReviews = 1;

              const reviewCount = await getValidReviewCount(prNumber, pr.user.login);
              const reviewStatus = `${reviewCount}/${requiredReviews}`;

              // í•œ ë²ˆ ì‹¤í–‰ë‹¹ PRë‹¹ ì•Œë¦¼ 1ê°œë§Œ (ìš°ì„ ìˆœìœ„: 24h ë¦¬ë·° ë¶€ì¡± > SLA ê¸´ê¸‰ > ë¨¸ì§€ ë¦¬ë§ˆì¸ë“œ ì¤‘ ê°€ì¥ ê¸´ ì‹œê°„)
              let sent = false;

              // 1) Base rule: any PR -> 24h ì‹œì ì— ë¦¬ë·° 0ê°œë©´ ì•Œë¦¼ (ë”± 1ë²ˆ)
              if (!sent && ageH >= 24 && reviewCount < requiredReviews && !hasLabel(pr, "bot/reminded-base-24h")) {
                await sendDiscord({
                  content: URGENT_MENTIONS || "@here",
                  title: "â° 24ì‹œê°„ ê²½ê³¼: ë¦¬ë·°ê°€ ì•„ì§ ë¶€ì¡±í•´ìš”",
                  pr,
                  extraFields: [
                    { name: "ìœ íš¨ ë¦¬ë·° ìˆ˜ (CODEOWNER ê¸°ì¤€)", value: reviewStatus, inline: true },
                    { name: "ìš”ì²­", value: "ì²« ë¦¬ë·° ë°˜ì‘(ì½”ë©˜íŠ¸/ìŠ¹ì¸/ìˆ˜ì •ìš”ì²­)ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.", inline: false }
                  ]
                });
                await addBotLabel(prNumber, "bot/reminded-base-24h");
                sent = true;
              }

              // 2) SLA Miss (priority/high + review/24h or 48h)
              if (!sent && hasPriorityHigh && hasReview24 && ageH >= 24 && reviewCount < requiredReviews && !hasLabel(pr, "bot/reminded-sla24-24h")) {
                await sendDiscord({
                  content: URGENT_MENTIONS || "@here",
                  title: "ğŸš¨ ê¸´ê¸‰ PR: review/24h ë¦¬ë·° ì‘ë‹µ ëª©í‘œë¥¼ ë„˜ê²¼ì–´ìš”",
                  pr,
                  extraFields: [
                    { name: "ìœ íš¨ ë¦¬ë·° ìˆ˜ (CODEOWNER ê¸°ì¤€)", value: reviewStatus, inline: true },
                    { name: "ì§€ê¸ˆ í•„ìš”í•œ ê²ƒ", value: "CODEOWNER ê¸°ì¤€ìœ¼ë¡œ ë¦¬ë·° 1ê°œ ì´ìƒì„ ë‚¨ê²¨ì£¼ì„¸ìš”.", inline: false }
                  ]
                });
                await addBotLabel(prNumber, "bot/reminded-sla24-24h");
                sent = true;
              }
              if (!sent && hasPriorityHigh && hasReview48 && ageH >= 48 && reviewCount < requiredReviews && !hasLabel(pr, "bot/reminded-sla48-48h")) {
                await sendDiscord({
                  content: URGENT_MENTIONS || "@here",
                  title: "ğŸš¨ ê¸´ê¸‰ PR: review/48h ë¦¬ë·° ì‘ë‹µ ëª©í‘œë¥¼ ë„˜ê²¼ì–´ìš”",
                  pr,
                  extraFields: [
                    { name: "ìœ íš¨ ë¦¬ë·° ìˆ˜ (CODEOWNER ê¸°ì¤€)", value: reviewStatus, inline: true },
                    { name: "ì§€ê¸ˆ í•„ìš”í•œ ê²ƒ", value: "CODEOWNER ê¸°ì¤€ìœ¼ë¡œ ë¦¬ë·° 1ê°œ ì´ìƒì„ ë‚¨ê²¨ì£¼ì„¸ìš”.", inline: false }
                  ]
                });
                await addBotLabel(prNumber, "bot/reminded-sla48-48h");
                sent = true;
              }

              // 3) Merge reminders (72h > 60h > 48h ìˆœìœ¼ë¡œ í•˜ë‚˜ë§Œ)
              if (!sent && ageH >= 72 && !hasLabel(pr, "bot/reminded-merge-72h")) {
                await sendDiscord({
                  content: "@here",
                  title: "ğŸ” ë¨¸ì§€ ë¦¬ë§ˆì¸ë“œ: PRì´ 72ì‹œê°„ì§¸ ì—´ë ¤ ìˆì–´ìš”",
                  pr,
                  extraFields: [
                    { name: "ìœ íš¨ ë¦¬ë·° ìˆ˜ (CODEOWNER ê¸°ì¤€)", value: reviewStatus, inline: true }
                  ]
                });
                await addBotLabel(prNumber, "bot/reminded-merge-72h");
                sent = true;
              }
              if (!sent && ageH >= 60 && !hasLabel(pr, "bot/reminded-merge-60h")) {
                await sendDiscord({
                  content: "@here",
                  title: "ğŸ” ë¨¸ì§€ ë¦¬ë§ˆì¸ë“œ: PRì´ 60ì‹œê°„ì§¸ ì—´ë ¤ ìˆì–´ìš”",
                  pr,
                  extraFields: [
                    { name: "ìœ íš¨ ë¦¬ë·° ìˆ˜ (CODEOWNER ê¸°ì¤€)", value: reviewStatus, inline: true }
                  ]
                });
                await addBotLabel(prNumber, "bot/reminded-merge-60h");
                sent = true;
              }
              if (!sent && ageH >= 48 && !hasLabel(pr, "bot/reminded-merge-48h")) {
                await sendDiscord({
                  content: "@here",
                  title: "ğŸ” ë¨¸ì§€ ë¦¬ë§ˆì¸ë“œ: PRì´ 48ì‹œê°„ì§¸ ì—´ë ¤ ìˆì–´ìš”",
                  pr,
                  extraFields: [
                    { name: "ìœ íš¨ ë¦¬ë·° ìˆ˜ (CODEOWNER ê¸°ì¤€)", value: reviewStatus, inline: true }
                  ]
                });
                await addBotLabel(prNumber, "bot/reminded-merge-48h");
              }
            }
